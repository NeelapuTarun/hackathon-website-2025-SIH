<!DOCTYPE html>
<html lang="en" data-lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
	<title>SmartCommute – Bus Tracker</title>
	<meta name="theme-color" content="#000000" />
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
	<style>
		:root { 
			--bg: #f8f9fa; 
			--fg: #1a1a1a; 
			--muted: #6c757d; 
			--line: #e9ecef; 
			--card: #ffffff; 
			--ok: #28a745; 
			--danger: #dc3545; 
			--accent: #007bff;
			--shadow: 0 2px 10px rgba(0,0,0,0.1);
		}
		* { box-sizing: border-box; }
		html, body { height: 100%; margin: 0; font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--fg); line-height: 1.6; }
		.app { display: flex; flex-direction: column; min-height: 100dvh; }
		
		header { 
			position: sticky; top: 0; z-index: 10; 
			background: rgba(255,255,255,0.95); 
			border-bottom: 1px solid var(--line); 
			backdrop-filter: blur(10px);
			box-shadow: var(--shadow);
		}
		.header-inner { 
			display: flex; align-items: center; justify-content: space-between; 
			height: 70px; padding: 0 24px; gap: 20px; 
		}
		.brand { 
			font-weight: 700; letter-spacing: 0.5px; font-size: 20px; 
			background: linear-gradient(135deg, var(--accent), #0056b3);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
		}
		.actions { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
		
		button { 
			background: var(--accent); color: white; border: none; 
			border-radius: 12px; padding: 12px 20px; font-weight: 600; 
			cursor: pointer; transition: all 0.3s ease; font-family: inherit;
			box-shadow: var(--shadow);
		}
		button:hover { 
			background: #0056b3; transform: translateY(-2px); 
			box-shadow: 0 4px 20px rgba(0,123,255,0.3);
		}
		.btn-secondary { 
			background: transparent; color: var(--fg); 
			border: 2px solid var(--line); 
		}
		.btn-secondary:hover { 
			background: var(--line); border-color: var(--accent);
		}
		.btn-small { padding: 8px 16px; font-size: 14px; }
		
		.input { 
			background: var(--card); color: var(--fg); 
			border: 2px solid var(--line); border-radius: 12px; 
			padding: 14px 18px; width: 100%; font-family: inherit;
			transition: all 0.3s ease;
		}
		.input:focus { 
			outline: none; border-color: var(--accent); 
			box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
		}
		
		.suggest-box { position: relative; }
		.suggest-list { 
			position: absolute; top: 60px; left: 0; right: 0; 
			background: var(--card); border: 2px solid var(--line); 
			border-radius: 12px; overflow: hidden; max-height: 300px; 
			overflow-y: auto; display: none; z-index: 20; 
			box-shadow: 0 8px 30px rgba(0,0,0,0.15);
		}
		.suggest-item { 
			padding: 14px 18px; border-bottom: 1px solid var(--line); 
			cursor: pointer; color: var(--fg); transition: all 0.2s ease;
		}
		.suggest-item:last-child { border-bottom: none; }
		.suggest-item:hover { background: #f8f9fa; }
		
		main { flex: 1; display: flex; flex-direction: column; }
		.toolbar { 
			display: flex; gap: 16px; padding: 20px 24px; 
			border-bottom: 1px solid var(--line); flex-wrap: wrap; 
			align-items: center; background: var(--card);
		}
		.toolbar .pill { 
			background: #e3f2fd; color: var(--accent); 
			border-radius: 25px; padding: 10px 20px; 
			font-size: 14px; font-weight: 600;
		}
		.toolbar .status { 
			margin-left: auto; color: var(--muted); 
			font-size: 14px; font-weight: 500;
		}
		
		.layout { 
			display: grid; grid-template-columns: 1.3fr 0.7fr; 
			gap: 20px; padding: 20px 24px; flex: 1;
		}
		@media (max-width: 1024px) { 
			.layout { grid-template-columns: 1fr; } 
		}
		
		.panel { 
			background: var(--card); border: 1px solid var(--line); 
			border-radius: 16px; overflow: hidden; 
			box-shadow: var(--shadow);
		}
		.panel-header { 
			padding: 20px 24px; border-bottom: 1px solid var(--line); 
			display: flex; align-items: center; justify-content: space-between; 
			gap: 16px; background: #fafbfc;
		}
		.panel-title { font-weight: 600; font-size: 18px; color: var(--fg); }
		.panel-body { padding: 0; }
		
		#map { 
			width: 100%; height: 75dvh; border-radius: 0 0 16px 16px;
			position: relative;
		}
		
		/* Compass */
		.compass {
			position: absolute;
			top: 20px;
			right: 20px;
			width: 60px;
			height: 60px;
			background: white;
			border-radius: 50%;
			box-shadow: 0 4px 20px rgba(0,0,0,0.15);
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 1000;
			font-weight: bold;
			font-size: 12px;
		रंग: #333;
		}
		.compass::before {
			content: 'N';
			position: absolute;
			top: 8px;
			color: #dc3545;
			font-weight: bold;
		}
		.compass::after {
			content: 'S';
			position: absolute;
			bottom: 8px;
			color: #333;
		}
		.compass .east { position: absolute; right: 8px; color: #333; }
		.compass .west { position: absolute; left: 8px; color: #333; }
		
		.hidden { display: none !important; }

		.list { display: flex; flex-direction: column; }
		.item { 
			padding: 20px 24px; border-bottom: 1px solid var(--line); 
			cursor: pointer; transition: all 0.3s ease;
		}
		.item:last-child { border-bottom: none; }
		.item:hover { 
			background: #f8f9fa; transform: translateX(4px);
		}
		.item.selected { 
			background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
			border-left: 4px solid var(--accent);
			transform: translateX(8px);
		}
		.item-name { 
			font-weight: 600; margin-bottom: 6px; 
			font-size: 16px; color: var(--fg);
		}
		.item-detail { 
			color: var(--muted); font-size: 14px; 
			margin-bottom: 8px;
		}
		.item-distance { 
			color: var(--ok); font-weight: 600; 
			font-size: 14px;
		}

		.bus-item { 
			padding: 16px 24px; border-bottom: 1px solid var(--line); 
			background: #fafbfc; margin: 8px 0;
			border-radius: 12px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.05);
		}
		.bus-item:last-child { border-bottom: none; }
		.bus-route { 
			font-weight: 700; color: var(--accent); 
			font-size: 18px; margin-bottom: 4px;
		}
		.bus-eta { 
			color: var(--ok); font-weight: 600; 
			font-size: 16px; margin-bottom: 4px;
		}
		.bus-occupancy { 
			color: var(--muted); font-size: 14px; 
			margin-bottom: 4px;
		}
		.bus-availability { 
			color: var(--muted); font-size: 12px; 
			font-style: italic;
		}

		.modal { 
			position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
			background: rgba(0,0,0,0.6); display: flex; 
			align-items: center; justify-content: center; z-index: 1000; 
			padding: 20px; backdrop-filter: blur(5px);
		}
		.modal-content { 
			background: var(--card); border-radius: 20px; 
			padding: 40px; width: 100%; max-width: 450px; 
			border: 1px solid var(--line); position: relative;
			box-shadow: 0 20px 60px rgba(0,0,0,0.3);
		}
		.modal-title { 
			font-size: 28px; font-weight: 700; margin-bottom: 30px; 
			text-align: center; color: var(--fg);
		}
		.form-group { margin-bottom: 24px; }
		.form-label { 
			display: block; margin-bottom: 10px; 
			font-weight: 600; color: var(--fg);
		}
		.form-row { display: flex; gap: 16px; }
		.form-row .form-group { flex: 1; }
		.country-select { 
			background: var(--card); color: var(--fg); 
			border: 2px solid var(--line); border-radius: 12px; 
			padding: 14px 18px; font-family: inherit;
		}
		.submit-btn { 
			width: 100%; padding: 16px; font-size: 18px; 
			margin-top: 12px; border-radius: 12px;
		}
		.close-btn { 
			position: absolute; top: 20px; right: 20px; 
			background: none; border: none; color: var(--muted); 
			font-size: 28px; cursor: pointer;
		}

		.language-selector { position: relative; }
		.lang-btn { 
			background: var(--line); color: var(--fg); 
			border: 2px solid var(--line); padding: 10px 16px; 
			border-radius: 10px; cursor: pointer; font-size: 14px;
		}
		.lang-dropdown { 
			position: absolute; top: 100%; right: 0; 
			background: var(--card); border: 2px solid var(--line); 
			border-radius: 12px; overflow: hidden; display: none; 
			z-index: 20; min-width: 140px;
			box-shadow: 0 8px 30px rgba(0,0,0,0.15);
		}
		.lang-option { 
			padding: 12px 20px; cursor: pointer; color: var(--fg); 
			transition: all 0.2s ease;
		}
		.lang-option:hover { background: #f8f9fa; }

		.sms-btn { 
			background: var(--ok); color: white; 
		}
		.sms-btn:hover { 
			background: #218838; 
		}

		/* Beautiful Bus Markers with Animation */
		.bus-marker { 
			background: linear-gradient(135deg, #ff6b6b, #ee5a24);
			color: white; border-radius: 50%; width: 40px; height: 40px; 
			display: flex; align-items: center; justify-content: center; 
			font-weight: bold; font-size: 14px; border: 3px solid white; 
			box-shadow: 0 4px 15px rgba(0,0,0,0.3);
			animation: busPulse 2s infinite;
		}
		
		@keyframes busPulse {
			0%, 100% { 
				transform: scale(1); 
				box-shadow: 0 4px 15px rgba(0,0,0,0.3);
			}
			50% { 
				transform: scale(1.1); 
				box-shadow: 0 6px 20px rgba(0,0,0,0.4);
			}
		}
		
		.eta-bubble { 
			background: white; color: var(--fg); 
			padding: 6px 12px; border-radius: 15px; 
			font-size: 12px; font-weight: 700; 
			margin-top: 6px; box-shadow: 0 3px 10px rgba(0,0,0,0.2);
			border: 2px solid var(--accent);
		}

		@media (max-width: 768px) {
			.header-inner { padding: 0 16px; }
			.layout { padding: 16px; gap: 16px; }
			.toolbar { padding: 16px; }
			.compass { width: 50px; height: 50px; top: 15px; right: 15px; }
		}
	</style>
</head>
<body>
	<div class="app">
		<!-- Login Modal -->
		<div id="loginModal" class="modal">
			<div class="modal-content">
				<button class="close-btn" onclick="closeLogin()">&times;</button>
				<h2 class="modal-title">Welcome to SmartCommute</h2>
				<form id="loginForm">
					<div class="form-group">
						<label class="form-label" data-i18n="name">Full Name</label>
						<input type="text" class="input" id="userName" required>
					</div>
					<div class="form-row">
						<div class="form-group">
							<label class="form-label" data-i18n="country">Country</label>
							<select class="country-select" id="countryCode">
								<option value="+91">🇮 India (+91)</option>
								<option value="+1">🇸 USA (+1)</option>
								<option value="+44">🇬🇧 UK (+44)</option>
								<option value="+86">🇨🇳 China (+86)</option>
							</select>
						</div>
						<div class="form-group">
							<label class="form-label" data-i18n="phone">Phone Number</label>
							<input type="tel" class="input" id="userPhone" required>
						</div>
					</div>
					<div class="form-group">
						<label class="form-label" data-i18n="email">Email Address</label>
						<input type="email" class="input" id="userEmail" required>
					</div>
					<button type="submit" class="submit-btn" data-i18n="getStarted">Get Started</button>
				</form>
			</div>
		</div>

		<!-- Main App -->
		<div id="mainApp" class="hidden">
			<header>
				<div class="header-inner">
					<div class="brand">SmartCommute</div>
					<div class="actions">
						<div class="language-selector">
							<button class="lang-btn" onclick="toggleLanguage()">
								<span id="currentLang">English</span> ▼
							</button>
							<div class="lang-dropdown" id="langDropdown">
								<div class="lang-option" onclick="setLanguage('en')">English</div>
								<div class="lang-option" onclick="setLanguage('hi')">हिन्दी</div>
								<div class="lang-option" onclick="setLanguage('te')">తెలుగు</div>
							</div>
						</div>
						<button class="btn-secondary btn-small" onclick="showLocationInput()" data-i18n="changeLocation">Change Location</button>
						<button class="sms-btn btn-small" onclick="sendSMS()" data-i18n="sendSMS"> SMS</button>
					</div>
				</div>
			</header>

			<main>
				<div class="toolbar">
					<div class="pill" data-i18n="nearbyStops">Nearby Bus Stops</div>
					<div class="pill" id="locationStatus" data-i18n="detectingLocation">Detecting location...</div>
					<div class="status" id="connectionStatus" data-i18n="online">Online</div>
				</div>

				<div class="layout">
					<div class="panel">
						<div class="panel-header">
							<div class="panel-title" data-i18n="mapView">Map View</div>
							<button class="btn-secondary btn-small" onclick="clearSelection()" data-i18n="clearSelection">Clear Selection</button>
						</div>
						<div class="panel-body">
							<div id="map">
								<div class="compass">
									<div class="east">E</div>
									<div class="west">W</div>
								</div>
							</div>
						</div>
					</div>

					<div class="panel">
						<div class="panel-header">
							<div class="panel-title" data-i18n="busStops">Bus Stops</div>
						</div>
						<div class="panel-body">
							<div class="list" id="stopsList"></div>
						</div>
					</div>
				</div>
			</main>
		</div>

		<!-- Location Input Modal -->
		<div id="locationModal" class="modal hidden">
			<div class="modal-content">
				<button class="close-btn" onclick="closeLocationInput()">&times;</button>
				<h2 class="modal-title" data-i18n="enterLocation">Enter Your Location</h2>
				<div class="form-group">
					<label class="form-label" data-i18n="address">Address</label>
					<div class="suggest-box">
						<input type="text" class="input" id="addressInput" placeholder="e.g., Gitam Backgate, Visakhapatnam" data-i18n-placeholder="addressPlaceholder">
						<div class="suggest-list" id="addressSuggestions"></div>
					</div>
				</div>
				<button class="submit-btn" onclick="useAddressLocation()" data-i18n="useThisLocation">Use This Location</button>
			</div>
		</div>
	</div>

	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
	<script>
		// Global state
		let map, userLocation, selectedStop, busMarkers = [], routeLine, isOnline = navigator.onLine;
		let lastLocationData = JSON.parse(localStorage.getItem('lastLocationData') || '{}');
		let translations = {
			en: {
				name: 'Full Name', country: 'Country', phone: 'Phone Number', email: 'Email Address',
				getStarted: 'Get Started', changeLocation: 'Change Location', sendSMS: ' SMS',
				nearbyStops: 'Nearby Bus Stops', detectingLocation: 'Detecting location...',
				online: 'Online', offline: 'Offline', mapView: 'Map View', busStops: 'Bus Stops',
				clearSelection: 'Clear Selection', enterLocation: 'Enter Your Location',
				address: 'Address', addressPlaceholder: 'e.g., Gitam Backgate, Visakhapatnam',
				useThisLocation: 'Use This Location', noStopsFound: 'No bus stops found nearby',
				selectStop: 'Select a bus stop to see arrivals', arrivals: 'Arrivals',
				route: 'Route', eta: 'ETA', occupancy: 'Occupancy', availability: 'Available',
				from: 'from', to: 'to', smsText: 'Bus info for', at: 'at', arrivalsText: 'Arrivals'
			},
			hi: {
				name: 'पूरा नाम', country: 'देश', phone: 'फोन नंबर', email: 'ईमेल पता',
				getStarted: 'शुरू करें', changeLocation: 'स्थान बदलें', sendSMS: ' SMS',
				nearbyStops: 'पास के बस स्टॉप', detectingLocation: 'स्थान का पता लगाया जा रहा है...',
				online: 'ऑनलाइन', offline: 'ऑफलाइन', mapView: 'मानचित्र दृश्य', busStops: 'बस स्टॉप',
				clearSelection: 'चयन साफ़ करें', enterLocation: 'अपना स्थान दर्ज करें',
				address: 'पता', addressPlaceholder: 'जैसे, गीतम बैकगेट, विशाखापत्तनम',
				useThisLocation: 'इस स्थान का उपयोग करें', noStopsFound: 'पास में कोई बस स्टॉप नहीं मिला',
				selectStop: 'आगमन देखने के लिए बस स्टॉप चुनें', arrivals: 'आगमन',
				route: 'रूट', eta: 'समय', occupancy: 'भीड़', availability: 'उपलब्ध',
				from: 'से', to: 'तक', smsText: 'बस जानकारी', at: 'पर', arrivalsText: 'आगमन'
			},
			te: {
				name: 'పూర్తి పేరు', country: 'దేశం', phone: 'ఫోన్ నంబర్', email: 'ఇమెయిల్ చిరునామా',
				getStarted: 'ప్రారంభించండి', changeLocation: 'స్థానం మార్చండి', sendSMS: '📱 SMS',
				nearbyStops: 'సమీప బస్ స్టాప్లు', detectingLocation: 'స్థానం గుర్తించబడుతోంది...',
				online: 'ఆన్‌లైన్', offline: 'ఆఫ్‌లైన్', mapView: 'మ్యాప్ వ్యూ', busStops: 'బస్ స్టాప్లు',
				clearSelection: 'ఎంపిక క్లియర్ చేయండి', enterLocation: 'మీ స్థానం నమోదు చేయండి',
				address: 'చిరునామా', addressPlaceholder: 'ఉదా., గీతం బ్యాక్‌గేట్, విశాఖపట్నం',
				useThisLocation: 'ఈ స్థానాన్ని ఉపయోగించండి', noStopsFound: 'సమీపంలో బస్ స్టాప్లు లేవు',
				selectStop: 'ఆగమనాలను చూడటానికి బస్ స్టాప్ ఎంచుకోండి', arrivals: 'ఆగమనాలు',
				route: 'రూట్', eta: 'సమయం', occupancy: 'గుంపు', availability: 'అందుబాటులో',
				from: 'నుండి', to: 'వరకు', smsText: 'బస్ సమాచారం', at: 'వద్ద', arrivalsText: 'ఆగమనాలు'
			}
		};

		// Initialize app
		document.addEventListener('DOMContentLoaded', function() {
			checkLoginStatus();
			setupEventListeners();
			updateConnectionStatus();
			window.addEventListener('online', function() { isOnline = true; updateConnectionStatus(); });
			window.addEventListener('offline', function() { isOnline = false; updateConnectionStatus(); });
		});

		function checkLoginStatus() {
			var userData = localStorage.getItem('userData');
			if (userData) {
				document.getElementById('loginModal').classList.add('hidden');
				document.getElementById('mainApp').classList.remove('hidden');
				initMap();
				detectLocation();
			}
		}

		function setupEventListeners() {
			document.getElementById('loginForm').addEventListener('submit', handleLogin);
			document.getElementById('addressInput').addEventListener('input', handleAddressInput);
			document.addEventListener('click', function(e) {
				if (!e.target.closest('.suggest-box')) {
					document.getElementById('addressSuggestions').style.display = 'none';
				}
				if (!e.target.closest('.language-selector')) {
					document.getElementById('langDropdown').style.display = 'none';
				}
			});
		}

		function handleLogin(e) {
			e.preventDefault();
			var name = document.getElementById('userName').value;
			var country = document.getElementById('countryCode').value;
			var phone = document.getElementById('userPhone').value;
			var email = document.getElementById('userEmail').value;

			var userData = {
				name: name,
				country: country,
				phone: country + phone,
				email: email
			};
			try {
				localStorage.setItem('userData', JSON.stringify(userData));
			} catch (err) {
				// As a fallback, keep state only in memory (session)
				window.__userData = userData;
			}
			document.getElementById('loginModal').classList.add('hidden');
			document.getElementById('mainApp').classList.remove('hidden');
			initMap();
			detectLocation();
		}

		function closeLogin() {
			// Prevent closing - user must login
		}

		function detectLocation() {
			updateLocationStatus('detectingLocation');
			
			fetch('https://ipapi.co/json/')
				.then(function(response) { return response.json(); })
				.then(function(data) {
					if (data && data.latitude && data.longitude) {
						userLocation = [data.latitude, data.longitude];
						updateLocationStatus('locationDetected');
						loadNearbyStops();
						updateMap();
					} else {
						fallbackToGPS();
					}
				})
				.catch(function() { fallbackToGPS(); });
		}

		function fallbackToGPS() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(
					function(position) {
						userLocation = [position.coords.latitude, position.coords.longitude];
						updateLocationStatus('locationDetected');
						loadNearbyStops();
						updateMap();
					},
					function() {
						updateLocationStatus('locationFailed');
						showLocationInput();
					}
				);
			} else {
				updateLocationStatus('locationFailed');
				showLocationInput();
			}
		}

		function showLocationInput() {
			document.getElementById('locationModal').classList.remove('hidden');
		}

		function closeLocationInput() {
			document.getElementById('locationModal').classList.add('hidden');
		}

		function handleAddressInput() {
			var query = document.getElementById('addressInput').value;
			if (query.length < 3) {
				document.getElementById('addressSuggestions').style.display = 'none';
				return;
			}

			fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(query) + '&limit=5')
				.then(function(response) { return response.json(); })
				.then(function(data) {
					var suggestions = (data || []).map(function(item) {
						return {
							display: item.display_name,
							lat: parseFloat(item.lat),
							lon: parseFloat(item.lon)
						};
					});
					showAddressSuggestions(suggestions);
				})
				.catch(function() {
					document.getElementById('addressSuggestions').style.display = 'none';
				});
		}

		function showAddressSuggestions(suggestions) {
			var container = document.getElementById('addressSuggestions');
			container.innerHTML = suggestions.map(function(s) {
				return '<div class="suggest-item" onclick="selectAddress(\'' + s.lat + '\', \'' + s.lon + '\', \'' + (s.display || '').replace(/'/g, "\\'") + '\')">' + s.display + '</div>';
			}).join('');
			container.style.display = 'block';
		}

		function selectAddress(lat, lon, display) {
			userLocation = [parseFloat(lat), parseFloat(lon)];
			document.getElementById('addressInput').value = display;
			document.getElementById('addressSuggestions').style.display = 'none';
			closeLocationInput();
			updateLocationStatus('locationDetected');
			loadNearbyStops();
			updateMap();
		}

		function useAddressLocation() {
			var address = document.getElementById('addressInput').value;
			if (address) {
				var suggestions = document.querySelectorAll('.suggest-item');
				if (suggestions.length > 0) {
					suggestions[0].click();
				} else {
					fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(address) + '&limit=1')
						.then(function(response) { return response.json(); })
						.then(function(data) {
							if (data && data.length > 0) {
								selectAddress(data[0].lat, data[0].lon, data[0].display_name);
							}
						});
				}
			}
		}

		function loadNearbyStops() {
			if (!userLocation) return;

			var lat = userLocation[0];
			var lon = userLocation[1];
			var radius = 2000;
			
			var overpassQuery = '\n\t\t\t\t[out:json][timeout:25];\n\t\t\t\t(\n\t\t\t\t\tnode["public_transport"="platform"]["bus"="yes"](around:' + radius + ',' + lat + ',' + lon + ');\n\t\t\t\t\tnode["highway"="bus_stop"](around:' + radius + ',' + lat + ',' + lon + ');\n\t\t\t\t);\n\t\t\t\tout geom;\n\t\t\t';

			fetch('https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(overpassQuery))
				.then(function(response) { return response.json(); })
				.then(function(data) {
					var elements = (data && data.elements) ? data.elements : [];
					var stops = elements.map(function(stop, index) {
						var hasTags = stop && stop.tags;
						var stopName = hasTags && stop.tags.name ? stop.tags.name : ('Bus Stop ' + (index + 1));
						return {
							id: stop.id || ('stop_' + index),
							name: stopName,
							lat: stop.lat,
							lon: stop.lon,
							distance: calculateDistance(userLocation, [stop.lat, stop.lon])
						};
					}).sort(function(a, b) { return a.distance - b.distance; });

					if (stops.length === 0) {
						createMockStops();
					} else {
						renderStops(stops);
						renderStopMarkers(stops);
					}
				})
				.catch(function() { createMockStops(); });
		}

		function createMockStops() {
			var mockStops = [
				{ id: 'stop1', name: 'MVP Madilapalem', lat: userLocation[0] + 0.001, lon: userLocation[1] + 0.001, distance: 0.1 },
				{ id: 'stop2', name: 'Gitam Backgate', lat: userLocation[0] - 0.002, lon: userLocation[1] + 0.003, distance: 0.2 },
				{ id: 'stop3', name: 'Rushikonda', lat: userLocation[0] + 0.003, lon: userLocation[1] - 0.001, distance: 0.3 },
				{ id: 'stop4', name: 'Beach Road', lat: userLocation[0] - 0.001, lon: userLocation[1] - 0.002, distance: 0.4 }
			];
			renderStops(mockStops);
			renderStopMarkers(mockStops);
		}

		function renderStops(stops) {
			var container = document.getElementById('stopsList');
			container.innerHTML = stops.map(function(stop) {
				return '\n\t\t\t\t<div class="item" onclick="selectStop(\'' + stop.id + '\')" data-stop-id="' + stop.id + '">\n\t\t\t\t\t<div class="item-name">' + stop.name + '</div>\n\t\t\t\t\t<div class="item-detail">' + stop.distance.toFixed(1) + ' km away</div>\n\t\t\t\t\t<div class="item-distance" id="arrivals-' + stop.id + '" style="display:none;"></div>\n\t\t\t\t</div>\n\t\t\t';
			}).join('');
		}

		function renderStopMarkers(stops) {
			if (!map) return;

			// Clear existing stop markers
			map.eachLayer(function(layer) {
				if (layer._stopMarker) {
					map.removeLayer(layer);
				}
			});

			// Add stop markers
			stops.forEach(function(stop) {
				var marker = L.circleMarker([stop.lat, stop.lon], {
					radius: 10,
					fillColor: '#28a745',
					color: '#ffffff',
					weight: 3,
					opacity: 1,
					fillOpacity: 0.8
				}).addTo(map);

				marker._stopMarker = true;
				marker._stopData = stop;
				marker.bindPopup('<strong>' + stop.name + '</strong><br>' + stop.distance.toFixed(1) + ' km away');
				marker.on('click', function() { selectStop(stop.id); });
			});
		}

		function selectStop(stopId) {
			// Clear previous selection and arrivals
			document.querySelectorAll('.item.selected').forEach(function(item) {
				item.classList.remove('selected');
			});
			document.querySelectorAll('[id^="arrivals-"]').forEach(function(el) {
				el.style.display = 'none';
				el.innerHTML = '';
			});

			// Clear previous bus animations and route
			clearBusAnimations();
			if (routeLine) {
				map.removeLayer(routeLine);
				routeLine = null;
			}

			// Select new stop
			var stopElement = document.querySelector('[data-stop-id="' + stopId + '"]');
			if (stopElement) {
				stopElement.classList.add('selected');
				selectedStop = stopId;
				showArrivals(stopId);
				drawRouteToStop(stopId);
				animateBusesToStop(stopId);
			}
		}

		function clearSelection() {
			selectedStop = null;
			document.querySelectorAll('.item.selected').forEach(function(item) {
				item.classList.remove('selected');
			});
			document.querySelectorAll('[id^="arrivals-"]').forEach(function(el) {
				el.style.display = 'none';
				el.innerHTML = '';
			});
			if (routeLine) {
				map.removeLayer(routeLine);
				routeLine = null;
			}
			clearBusAnimations();
		}

		function showArrivals(stopId) {
			var arrivalsContainer = document.getElementById('arrivals-' + stopId);
			if (!arrivalsContainer) return;

			var arrivals = [
				{ route: 'RTC-101', eta: '5 min', occupancy: 'Medium', availability: '6:00 AM - 10:00 PM' },
				{ route: 'RTC-205', eta: '12 min', occupancy: 'Low', availability: '5:30 AM - 11:00 PM' },
				{ route: 'RTC-78', eta: '18 min', occupancy: 'High', availability: '6:15 AM - 9:45 PM' }
			];

			arrivalsContainer.innerHTML = '\n\t\t\t\t<div style="margin-top:12px; font-size:16px; color:var(--accent); font-weight:700; text-align:center; padding:8px; background:#e3f2fd; border-radius:8px;">' + t('arrivals') + '</div>\n\t\t\t\t' + arrivals.map(function(arrival) {
				return '\n\t\t\t\t\t<div class="bus-item">\n\t\t\t\t\t\t<div class="bus-route">' + arrival.route + '</div>\n\t\t\t\t\t\t<div class="bus-eta">' + t('eta') + ': ' + arrival.eta + '</div>\n\t\t\t\t\t\t<div class="bus-occupancy">' + t('occupancy') + ': ' + arrival.occupancy + '</div>\n\t\t\t\t\t\t<div class="bus-availability">' + t('availability') + ': ' + arrival.availability + '</div>\n\t\t\t\t\t</div>\n\t\t\t\t';
			}).join('') + '\n\t\t\t';
			arrivalsContainer.style.display = 'block';
		}

		function drawRouteToStop(stopId) {
			if (!map || !userLocation) return;

			// Find stop coordinates
			var stopCoords = null;
			map.eachLayer(function(layer) {
				if (layer._stopMarker && layer._stopData && layer._stopData.id === stopId) {
					stopCoords = [layer._stopData.lat, layer._stopData.lon];
				}
			});

			if (!stopCoords) return;

			// Remove existing route
			if (routeLine) {
				map.removeLayer(routeLine);
			}

			// Try to get routing from OSRM for proper road-following
			fetch('https://router.project-osrm.org/route/v1/driving/' + userLocation[1] + ',' + userLocation[0] + ';' + stopCoords[1] + ',' + stopCoords[0] + '?overview=full&geometries=geojson')
				.then(function(response) { return response.json(); })
				.then(function(data) {
					var hasRoute = data && data.routes && data.routes[0];
					if (hasRoute) {
						var coordinates = data.routes[0].geometry.coordinates.map(function(coord) { return [coord[1], coord[0]]; });
						routeLine = L.polyline(coordinates, {
							color: '#007bff',
							weight: 6,
							opacity: 0.9,
							dashArray: '20, 15'
						}).addTo(map);
					} else {
						routeLine = L.polyline([userLocation, stopCoords], {
							color: '#007bff',
							weight: 6,
							opacity: 0.9,
							dashArray: '20, 15'
						}).addTo(map);
					}
				})
				.catch(function() {
					routeLine = L.polyline([userLocation, stopCoords], {
						color: '#007bff',
						weight: 6,
						opacity: 0.9,
						dashArray: '20, 15'
					}).addTo(map);
				});
		}

		function animateBusesToStop(stopId) {
			clearBusAnimations();

			// Get stop coordinates
			var stopCoords = null;
			map.eachLayer(function(layer) {
				if (layer._stopMarker && layer._stopData && layer._stopData.id === stopId) {
					stopCoords = [layer._stopData.lat, layer._stopData.lon];
				}
			});

			if (!stopCoords) return;

			// Create animated bus markers
			var busRoutes = ['RTC-101', 'RTC-205', 'RTC-78'];
			var busColors = ['#ff6b6b', '#4ecdc4', '#45b7d1'];

			busRoutes.forEach(function(route, index) {
				var startLat = stopCoords[0] + (Math.random() - 0.5) * 0.015;
				var startLon = stopCoords[1] + (Math.random() - 0.5) * 0.015;

				var busMarker = L.marker([startLat, startLon], {
					icon: L.divIcon({
						className: 'bus-marker',
						html: '<div style="background: linear-gradient(135deg, ' + busColors[index] + ', ' + busColors[index] + 'dd); color:white; border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:14px; border:3px solid white; box-shadow:0 4px 15px rgba(0,0,0,0.3); animation: busPulse 2s infinite;">' + route.split('-')[1] + '</div>',
						iconSize: [40, 40],
						iconAnchor: [20, 20]
					})
				}).addTo(map);

				var etaBubble = L.marker([startLat, startLon], {
					icon: L.divIcon({
						className: 'eta-bubble',
						html: '<div style="background:white; color:var(--fg); padding:6px 12px; border-radius:15px; font-size:12px; font-weight:700; margin-top:6px; box-shadow:0 3px 10px rgba(0,0,0,0.2); border:2px solid var(--accent);">' + (5 + index * 7) + ' min</div>',
						iconSize: [70, 25],
						iconAnchor: [35, 25]
					})
				}).addTo(map);

				busMarkers.push({ marker: busMarker, eta: etaBubble, route: route });

				animateBusToStop(busMarker, etaBubble, [startLat, startLon], stopCoords, route, index);
			});
		}

		function animateBusToStop(busMarker, etaBubble, startPos, endPos, route, index) {
			var duration = 12000 + (index * 3000);
			var startTime = Date.now();
			var etas = [5, 12, 18];

			function animate() {
				var elapsed = Date.now() - startTime;
				var progress = Math.min(elapsed / duration, 1);
				var easeProgress = 1 - Math.pow(1 - progress, 3);
				var currentLat = startPos[0] + (endPos[0] - startPos[0]) * easeProgress;
				var currentLon = startPos[1] + (endPos[1] - startPos[1]) * easeProgress;
				
				busMarker.setLatLng([currentLat, currentLon]);
				etaBubble.setLatLng([currentLat, currentLon]);
				
				var remainingTime = Math.max(0, etas[index] - Math.floor(progress * etas[index]));
				etaBubble.setIcon(L.divIcon({
					className: 'eta-bubble',
					html: '<div style="background:white; color:var(--fg); padding:6px 12px; border-radius:15px; font-size:12px; font-weight:700; margin-top:6px; box-shadow:0 3px 10px rgba(0,0,0,0.2); border:2px solid var(--accent);">' + remainingTime + ' min</div>',
					iconSize: [70, 25],
					iconAnchor: [35, 25]
				}));

				if (progress < 1) {
					requestAnimationFrame(animate);
				} else {
					setTimeout(function() {
						map.removeLayer(busMarker);
						map.removeLayer(etaBubble);
					}, 2000);
				}
			}
			animate();
		}

		function clearBusAnimations() {
			busMarkers.forEach(function(item) {
				var marker = item.marker;
				var eta = item.eta;
				if (map.hasLayer(marker)) map.removeLayer(marker);
				if (map.hasLayer(eta)) map.removeLayer(eta);
			});
			busMarkers = [];
		}

		function initMap() {
			if (map) return;

			map = L.map('map', {
				zoomControl: false,
				attributionControl: false
			}).setView([17.6868, 83.2185], 13);

			L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
				subdomains: 'abcd',
				maxZoom: 20
			}).addTo(map);

			if (userLocation) {
				var m = L.circleMarker(userLocation, {
					radius: 10,
					fillColor: '#ff3b30',
					color: '#ffffff',
					weight: 3,
					opacity: 1,
					fillOpacity: 0.8
				}).addTo(map).bindPopup('<strong>Your Location</strong>');
				m._userMarker = true;
			}
		}

		function updateMap() {
			if (!map || !userLocation) return;

			map.setView(userLocation, 15);
			
			map.eachLayer(function(layer) {
				if (layer._userMarker) {
					map.removeLayer(layer);
				}
			});

			var marker = L.circleMarker(userLocation, {
				radius: 10,
				fillColor: '#ff3b30',
				color: '#ffffff',
				weight: 3,
				opacity: 1,
				fillOpacity: 0.8
			}).addTo(map).bindPopup('<strong>Your Location</strong>');
			marker._userMarker = true;
		}

		function updateLocationStatus(status) {
			var statusElement = document.getElementById('locationStatus');
			var statusTexts = {
				detectingLocation: t('detectingLocation'),
				locationDetected: 'Location detected',
				locationFailed: 'Location detection failed'
			};
			statusElement.textContent = statusTexts[status] || status;
		}

		function updateConnectionStatus() {
			var statusElement = document.getElementById('connectionStatus');
			statusElement.textContent = isOnline ? t('online') : t('offline');
			statusElement.style.color = isOnline ? 'var(--ok)' : 'var(--danger)';
		}

		function calculateDistance(pos1, pos2) {
			var R = 6371;
			var dLat = (pos2[0] - pos1[0]) * Math.PI / 180;
			var dLon = (pos2[1] - pos1[1]) * Math.PI / 180;
			var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
				Math.cos(pos1[0] * Math.PI / 180) * Math.cos(pos2[0] * Math.PI / 180) *
				Math.sin(dLon/2) * Math.sin(dLon/2);
			var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
			return R * c;
		}

		function sendSMS() {
			if (!selectedStop || !userLocation) {
				alert('Please select a bus stop first');
				return;
			}

			var stopElement = document.querySelector('[data-stop-id="' + selectedStop + '"]');
			var stopName = stopElement ? stopElement.querySelector('.item-name').textContent : 'Selected Stop';
			
			var arrivalsElement = document.getElementById('arrivals-' + selectedStop);
			var arrivalsText = '';
			if (arrivalsElement) {
				var busItems = arrivalsElement.querySelectorAll('.bus-item');
				var top2 = Array.prototype.slice.call(busItems, 0, 2);
				arrivalsText = top2.map(function(item) {
					var route = item.querySelector('.bus-route').textContent;
					var eta = item.querySelector('.bus-eta').textContent;
					return route + ' - ' + eta;
				}).join(', ');
			}

			var message = t('smsText') + ' ' + stopName + ': ' + (arrivalsText || 'No arrivals available');
			var smsUrl = 'sms:?body=' + encodeURIComponent(message);
			window.open(smsUrl);
		}

		// Language functions
		function t(key) {
			var lang = document.documentElement.getAttribute('data-lang') || 'en';
			var pack = translations[lang] || translations.en;
			return (pack && pack[key]) ? pack[key] : (translations.en[key] || key);
		}

		function setLanguage(lang) {
			document.documentElement.setAttribute('data-lang', lang);
			document.getElementById('currentLang').textContent = 
				lang === 'en' ? 'English' : (lang === 'hi' ? 'हिन्दी' : 'తెలుగు');
			
			document.querySelectorAll('[data-i18n]').forEach(function(el) {
				var key = el.getAttribute('data-i18n');
				el.textContent = t(key);
			});
			
			document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) {
				var key = el.getAttribute('data-i18n-placeholder');
				el.placeholder = t(key);
			});
			
			document.getElementById('langDropdown').style.display = 'none';
		}

		function toggleLanguage() {
			var dropdown = document.getElementById('langDropdown');
			var display = dropdown.style.display;
			dropdown.style.display = display === 'block' ? 'none' : 'block';
		}
	</script>
</body>
</html>